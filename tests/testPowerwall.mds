# Licensed under the MIT License
# https://github.com/craigahobbs/tespo/blob/main/LICENSE

include '../powerwall.mds'


#
# powerwallBatteryPercent tests
#


function testPowerwallBatteryPercent()
    unittestDeepEquals( \
        powerwallBatteryPercent( \
            objectNew( \
                'name', 'Powerwall Scenario', \
                'batteryCapacity', 40, \
                'backupPercent', 20, \
                'chargeRatio', 0.95, \
                'dischargeRatio', 0.95, \
                'data', arrayNew( \
                    objectNew( \
                        powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 35), \
                        powerwallFieldHome, 0, powerwallFieldSolar, 0, powerwallFieldBatteryPercent, 50 \
                    ), \
                    objectNew( \
                        powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 40), \
                        powerwallFieldHome, 0, powerwallFieldSolar, 0, powerwallFieldBatteryPercent, 52 \
                    ) \
                ) \
            ) \
        ), \
        51 \
    )
endfunction
unittestRunTest('testPowerwallBatteryPercent')


#
# powerwallSimulate tests
#


function testPowerwallSimulate_zeroHome_zeroSolar()
    unittestDeepEquals( \
        powerwallSimulate( \
            objectNew( \
                'name', 'Powerwall Scenario', \
                'batteryCapacity', 40, \
                'backupPercent', 20, \
                'chargeRatio', 0.95, \
                'dischargeRatio', 0.95, \
                'data', arrayNew( \
                    objectNew( \
                        powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 35), \
                        powerwallFieldHome, 0, powerwallFieldSolar, 0 \
                    ), \
                    objectNew( \
                        powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 40), \
                        powerwallFieldHome, 0, powerwallFieldSolar, 0 \
                    ) \
                ) \
            ), \
            50 \
        ), \
        arrayNew( \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 35), \
                powerwallFieldHome, 0, powerwallFieldSolar, 0, \
                powerwallFieldGrid, 0, powerwallFieldPowerwall, 0, powerwallFieldBatteryPercent, 50 \
            ), \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 40), \
                powerwallFieldHome, 0, powerwallFieldSolar, 0, \
                powerwallFieldGrid, 0, powerwallFieldPowerwall, 0, powerwallFieldBatteryPercent, 50 \
            ) \
        ) \
    )
endfunction
unittestRunTest('testPowerwallSimulate_zeroHome_zeroSolar')


function testPowerwallSimulate_solarSurplus_battery100()
    unittestDeepEquals( \
        powerwallSimulate( \
            objectNew( \
                'name', 'Powerwall Scenario', \
                'batteryCapacity', 40, \
                'backupPercent', 20, \
                'chargeRatio', 0.95, \
                'dischargeRatio', 0.95, \
                'data', arrayNew( \
                    objectNew( \
                        powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 35), \
                        powerwallFieldHome, 0.6, powerwallFieldSolar, 6.4 \
                    ), \
                    objectNew( \
                        powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 40), \
                        powerwallFieldHome, 1.2, powerwallFieldSolar, 5.5 \
                    ), \
                    objectNew( \
                        powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 45), \
                        powerwallFieldHome, 0.8, powerwallFieldSolar, 6.1 \
                    ) \
                ) \
            ), \
            98.5 \
        ), \
        arrayNew( \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 35), \
                powerwallFieldHome, 0.6, powerwallFieldSolar, 6.4, \
                powerwallFieldGrid, 0, powerwallFieldPowerwall, -5.8, powerwallFieldBatteryPercent, 99.648 \
            ), \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 40), \
                powerwallFieldHome, 1.2, powerwallFieldSolar, 5.5, \
                powerwallFieldGrid, -3.721, powerwallFieldPowerwall, -1.779, powerwallFieldBatteryPercent, 100 \
            ), \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 45), \
                powerwallFieldHome, 0.8, powerwallFieldSolar, 6.1, \
                powerwallFieldGrid, -6.1, powerwallFieldPowerwall, 0, powerwallFieldBatteryPercent, 100 \
            ) \
        ) \
    )
endfunction
unittestRunTest('testPowerwallSimulate_solarSurplus_battery100')


#
# powerwallVehicleDeparted tests
#


function testPowerwallVehicleDeparted()
    unittestDeepEquals( \
        powerwallVehicleDeparted( \
            objectNew( \
                'departures', arrayNew( \
                    objectNew( \
                        'id', 'ID-1', \
                        'departure', 9, \
                        'arrival', 11, \
                        'batteryPercentChange', -10 \
                    ), \
                    objectNew( \
                        'id', 'ID-1', \
                        'departure', 18, \
                        'arrival', 21, \
                        'batteryPercentChange', -20 \
                    ) \
                ) \
            ), \
            'ID-1', \
            19 \
        ), \
        objectNew( \
            'id', 'ID-1', \
            'departure', 18, \
            'arrival', 21, \
            'batteryPercentChange', -20 \
        ) \
    )
endfunction
unittestRunTest('testPowerwallVehicleDeparted')


function testPowerwallVehicleDeparted_connected()
    unittestDeepEquals( \
        powerwallVehicleDeparted( \
            objectNew( \
                'departures', arrayNew( \
                    objectNew( \
                        'id', 'ID-1', \
                        'departure', 9, \
                        'arrival', 11, \
                        'batteryPercentChange', -10 \
                    ), \
                    objectNew( \
                        'id', 'ID-1', \
                        'departure', 18, \
                        'arrival', 21, \
                        'batteryPercentChange', -20 \
                    ) \
                ) \
            ), \
            'ID-1', \
            12 \
        ), \
        null \
    )
endfunction
unittestRunTest('testPowerwallVehicleDeparted_connected')


function testPowerwallVehicleDeparted_connected_id()
    unittestDeepEquals( \
        powerwallVehicleDeparted( \
            objectNew( \
                'departures', arrayNew( \
                    objectNew( \
                        'id', 'ID-1', \
                        'departure', 9, \
                        'arrival', 11, \
                        'batteryPercentChange', -10 \
                    ), \
                    objectNew( \
                        'id', 'ID-1', \
                        'departure', 18, \
                        'arrival', 21, \
                        'batteryPercentChange', -20 \
                    ) \
                ) \
            ), \
            'ID-2', \
            19 \
        ), \
        null \
    )
endfunction
unittestRunTest('testPowerwallVehicleDeparted_connected_id')


#
# powerwallValidateVehicleScenario tests
#


function testPowerwallValidateVehicleScenario()
    vehicleScenario = objectNew( \
        'vehicles', arrayNew( \
            objectNew( \
                'id', 'ID-1', \
                'battery', 75, \
                'batteryCapacity', 80, \
                'chargingRate', 5, \
                'chargingLimit', 90, \
                'minChargingRate', 5, \
                'maxChargingRate', 32, \
                'chargingVoltage', 240 \
            ) \
        ), \
        'days', arrayNew( \
            objectNew( \
                'departures', arrayNew( \
                    objectNew( \
                        'id', 'ID-1', \
                        'departure', 9, \
                        'arrival', 11, \
                        'batteryPercentChange', -10 \
                    ), \
                    objectNew( \
                        'id', 'ID-1', \
                        'departure', 18, \
                        'arrival', 21, \
                        'batteryPercentChange', -20 \
                    ) \
                ) \
            ) \
        ) \
    )
    unittestDeepEquals(powerwallValidateVehicleScenario(vehicleScenario), vehicleScenario)
endfunction
unittestRunTest('testPowerwallValidateVehicleScenario')


function testPowerwallValidateVehicleScenario_fail()
    unittestDeepEquals(powerwallValidateVehicleScenario(objectNew()), vehicleScenario)
endfunction
unittestRunTest('testPowerwallValidateVehicleScenario_fail')

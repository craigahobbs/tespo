# Licensed under the MIT License
# https://github.com/craigahobbs/tespo/blob/main/LICENSE

include '../powerwall.mds'


#
# powerwallBatteryPercent tests
#


function testPowerwallBatteryPercent()
    unittestEquals( \
        powerwallBatteryPercent( \
            objectNew( \
                'name', 'Powerwall Scenario', \
                'batteryCapacity', 40, \
                'backupPercent', 20, \
                'chargeRatio', 0.95, \
                'dischargeRatio', 0.95, \
                'data', arrayNew( \
                    objectNew( \
                        powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 35), \
                        powerwallFieldHome, 0, powerwallFieldSolar, 0, powerwallFieldBatteryPercent, 50 \
                    ), \
                    objectNew( \
                        powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 40), \
                        powerwallFieldHome, 0, powerwallFieldSolar, 0, powerwallFieldBatteryPercent, 52 \
                    ) \
                ) \
            ) \
        ), \
        48 \
    )
endfunction
unittestRunTest('testPowerwallBatteryPercent')


#
# powerwallSimulate tests
#


function testPowerwallSimulate_allZeroes()
    data = powerwallSimulate( \
        objectNew( \
            'name', 'Powerwall Scenario', \
            'batteryCapacity', 40, \
            'backupPercent', 20, \
            'chargeRatio', 0.95, \
            'dischargeRatio', 0.95, \
            'data', arrayNew( \
                objectNew( \
                    powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 35), \
                    powerwallFieldHome, 0, powerwallFieldSolar, 0 \
                ), \
                objectNew( \
                    powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 40), \
                    powerwallFieldHome, 0, powerwallFieldSolar, 0 \
                ) \
            ) \
        ), \
        50 \
    )
    unittestDeepEquals( \
        data, \
        arrayNew( \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 35), \
                powerwallFieldHome, 0, powerwallFieldSolar, 0, \
                powerwallFieldGrid, 0, powerwallFieldPowerwall, 0, \
                powerwallFieldBatteryPercent, 50, powerwallFieldBackupPercent, 20 \
            ), \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 40), \
                powerwallFieldHome, 0, powerwallFieldSolar, 0, \
                powerwallFieldGrid, 0, powerwallFieldPowerwall, 0, \
                powerwallFieldBatteryPercent, 50, powerwallFieldBackupPercent, 20 \
            ) \
        ) \
    )
endfunction
unittestRunTest('testPowerwallSimulate_allZeroes')


function testPowerwallSimulate_solarSurplus()
    data = powerwallSimulate( \
        objectNew( \
            'name', 'Powerwall Scenario', \
            'batteryCapacity', 40, \
            'backupPercent', 20, \
            'chargeRatio', 0.95, \
            'dischargeRatio', 0.95, \
            'data', arrayNew( \
                objectNew( \
                    powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 35), \
                    powerwallFieldHome, 0.6, powerwallFieldSolar, 6.4 \
                ), \
                objectNew( \
                    powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 40), \
                    powerwallFieldHome, 1.2, powerwallFieldSolar, 5.5 \
                ), \
                objectNew( \
                    powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 45), \
                    powerwallFieldHome, 0.8, powerwallFieldSolar, 6.1 \
                ) \
            ) \
        ), \
        98.5 \
    )
    unittestDeepEquals( \
        data, \
        arrayNew( \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 35), \
                powerwallFieldHome, 0.6, powerwallFieldSolar, 6.4, \
                powerwallFieldGrid, 0, powerwallFieldPowerwall, -5.8, \
                powerwallFieldBatteryPercent, 99.648, powerwallFieldBackupPercent, 20 \
            ), \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 40), \
                powerwallFieldHome, 1.2, powerwallFieldSolar, 5.5, \
                powerwallFieldGrid, -2.521, powerwallFieldPowerwall, -1.779, \
                powerwallFieldBatteryPercent, 100, powerwallFieldBackupPercent, 20 \
            ), \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 45), \
                powerwallFieldHome, 0.8, powerwallFieldSolar, 6.1, \
                powerwallFieldGrid, -5.3, powerwallFieldPowerwall, 0, \
                powerwallFieldBatteryPercent, 100, powerwallFieldBackupPercent, 20 \
            ) \
        ) \
    )
endfunction
unittestRunTest('testPowerwallSimulate_solarSurplus')


function testPowerwallSimulate_solarSurplus_nearBackup()
    data = powerwallSimulate( \
        objectNew( \
            'name', 'Powerwall Scenario', \
            'batteryCapacity', 40, \
            'backupPercent', 20, \
            'chargeRatio', 0.95, \
            'dischargeRatio', 0.95, \
            'data', arrayNew( \
                objectNew( \
                    powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 35), \
                    powerwallFieldHome, 0.6, powerwallFieldSolar, 6.4 \
                ), \
                objectNew( \
                    powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 40), \
                    powerwallFieldHome, 1.2, powerwallFieldSolar, 5.5 \
                ), \
                objectNew( \
                    powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 45), \
                    powerwallFieldHome, 0.8, powerwallFieldSolar, 6.1 \
                ) \
            ) \
        ), \
        18.5 \
    )
    unittestDeepEquals( \
        data, \
        arrayNew( \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 35), \
                powerwallFieldHome, 0.6, powerwallFieldSolar, 6.4, \
                powerwallFieldGrid, 0, powerwallFieldPowerwall, -5.8, \
                powerwallFieldBatteryPercent, 19.648, powerwallFieldBackupPercent, 20 \
            ), \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 40), \
                powerwallFieldHome, 1.2, powerwallFieldSolar, 5.5, \
                powerwallFieldGrid, 0, powerwallFieldPowerwall, -4.3, \
                powerwallFieldBatteryPercent, 20.499, powerwallFieldBackupPercent, 20 \
            ), \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 45), \
                powerwallFieldHome, 0.8, powerwallFieldSolar, 6.1, \
                powerwallFieldGrid, 0, powerwallFieldPowerwall, -5.3, \
                powerwallFieldBatteryPercent, 21.548, powerwallFieldBackupPercent, 20 \
            ) \
        ) \
    )
endfunction
unittestRunTest('testPowerwallSimulate_solarSurplus_nearBackup')


function testPowerwallSimulate_solarSurplus_belowBackup()
    data = powerwallSimulate( \
        objectNew( \
            'name', 'Powerwall Scenario', \
            'batteryCapacity', 40, \
            'backupPercent', 20, \
            'chargeRatio', 0.95, \
            'dischargeRatio', 0.95, \
            'data', arrayNew( \
                objectNew( \
                    powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 35), \
                    powerwallFieldHome, 0.6, powerwallFieldSolar, 6.4 \
                ), \
                objectNew( \
                    powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 40), \
                    powerwallFieldHome, 1.2, powerwallFieldSolar, 5.5 \
                ), \
                objectNew( \
                    powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 45), \
                    powerwallFieldHome, 0.8, powerwallFieldSolar, 6.1 \
                ) \
            ) \
        ), \
        15 \
    )
    unittestDeepEquals( \
        data, \
        arrayNew( \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 35), \
                powerwallFieldHome, 0.6, powerwallFieldSolar, 6.4, \
                powerwallFieldGrid, 0, powerwallFieldPowerwall, -5.8, \
                powerwallFieldBatteryPercent, 16.148, powerwallFieldBackupPercent, 20 \
            ), \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 40), \
                powerwallFieldHome, 1.2, powerwallFieldSolar, 5.5, \
                powerwallFieldGrid, 0, powerwallFieldPowerwall, -4.3, \
                powerwallFieldBatteryPercent, 16.999, powerwallFieldBackupPercent, 20 \
            ), \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 45), \
                powerwallFieldHome, 0.8, powerwallFieldSolar, 6.1, \
                powerwallFieldGrid, 0, powerwallFieldPowerwall, -5.3, \
                powerwallFieldBatteryPercent, 18.048, powerwallFieldBackupPercent, 20 \
            ) \
        ) \
    )
endfunction
unittestRunTest('testPowerwallSimulate_solarSurplus_belowBackup')


function testPowerwallSimulate_solarDeficit()
    data = powerwallSimulate( \
        objectNew( \
            'name', 'Powerwall Scenario', \
            'batteryCapacity', 40, \
            'backupPercent', 20, \
            'chargeRatio', 0.95, \
            'dischargeRatio', 0.95, \
            'data', arrayNew( \
                objectNew( \
                    powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 35), \
                    powerwallFieldHome, 6.4, powerwallFieldSolar, 0.6 \
                ), \
                objectNew( \
                    powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 40), \
                    powerwallFieldHome, 5.5, powerwallFieldSolar, 1.2 \
                ), \
                objectNew( \
                    powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 45), \
                    powerwallFieldHome, 6.1, powerwallFieldSolar, 0.8 \
                ) \
            ) \
        ), \
        100 \
    )
    unittestDeepEquals( \
        data, \
        arrayNew( \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 35), \
                powerwallFieldHome, 6.4, powerwallFieldSolar, 0.6, \
                powerwallFieldGrid, 0, powerwallFieldPowerwall, 5.8, \
                powerwallFieldBatteryPercent, 98.728, powerwallFieldBackupPercent, 20 \
            ), \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 40), \
                powerwallFieldHome, 5.5, powerwallFieldSolar, 1.2, \
                powerwallFieldGrid, 0, powerwallFieldPowerwall, 4.3, \
                powerwallFieldBatteryPercent, 97.785, powerwallFieldBackupPercent, 20 \
            ), \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 45), \
                powerwallFieldHome, 6.1, powerwallFieldSolar, 0.8, \
                powerwallFieldGrid, 0, powerwallFieldPowerwall, 5.3, \
                powerwallFieldBatteryPercent, 96.623, powerwallFieldBackupPercent, 20 \
            ) \
        ) \
    )
endfunction
unittestRunTest('testPowerwallSimulate_solarDeficit')


function testPowerwallSimulate_solarDeficit_nearBackup()
    data = powerwallSimulate( \
        objectNew( \
            'name', 'Powerwall Scenario', \
            'batteryCapacity', 40, \
            'backupPercent', 20, \
            'chargeRatio', 0.95, \
            'dischargeRatio', 0.95, \
            'data', arrayNew( \
                objectNew( \
                    powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 35), \
                    powerwallFieldHome, 6.4, powerwallFieldSolar, 0.6 \
                ), \
                objectNew( \
                    powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 40), \
                    powerwallFieldHome, 5.5, powerwallFieldSolar, 1.2 \
                ), \
                objectNew( \
                    powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 45), \
                    powerwallFieldHome, 6.1, powerwallFieldSolar, 0.8 \
                ) \
            ) \
        ), \
        21.5 \
    )
    unittestDeepEquals( \
        data, \
        arrayNew( \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 35), \
                powerwallFieldHome, 6.4, powerwallFieldSolar, 0.6, \
                powerwallFieldGrid, 0, powerwallFieldPowerwall, 5.8, \
                powerwallFieldBatteryPercent, 20.228, powerwallFieldBackupPercent, 20 \
            ), \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 40), \
                powerwallFieldHome, 5.5, powerwallFieldSolar, 1.2, \
                powerwallFieldGrid, 3.26, powerwallFieldPowerwall, 1.04, \
                powerwallFieldBatteryPercent, 20, powerwallFieldBackupPercent, 20 \
            ), \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 45), \
                powerwallFieldHome, 6.1, powerwallFieldSolar, 0.8, \
                powerwallFieldGrid, 5.3, powerwallFieldPowerwall, 0, \
                powerwallFieldBatteryPercent, 20, powerwallFieldBackupPercent, 20 \
            ) \
        ) \
    )
endfunction
unittestRunTest('testPowerwallSimulate_solarDeficit_nearBackup')


function testPowerwallSimulate_solarDeficit_belowBackup()
    data = powerwallSimulate( \
        objectNew( \
            'name', 'Powerwall Scenario', \
            'batteryCapacity', 40, \
            'backupPercent', 20, \
            'chargeRatio', 0.95, \
            'dischargeRatio', 0.95, \
            'data', arrayNew( \
                objectNew( \
                    powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 35), \
                    powerwallFieldHome, 6.4, powerwallFieldSolar, 0.6 \
                ), \
                objectNew( \
                    powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 40), \
                    powerwallFieldHome, 5.5, powerwallFieldSolar, 1.2 \
                ), \
                objectNew( \
                    powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 45), \
                    powerwallFieldHome, 6.1, powerwallFieldSolar, 0.8 \
                ) \
            ) \
        ), \
        15 \
    )
    unittestDeepEquals( \
        data, \
        arrayNew( \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 35), \
                powerwallFieldHome, 6.4, powerwallFieldSolar, 0.6, \
                powerwallFieldGrid, 5.8, powerwallFieldPowerwall, 0, \
                powerwallFieldBatteryPercent, 15, powerwallFieldBackupPercent, 20 \
            ), \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 40), \
                powerwallFieldHome, 5.5, powerwallFieldSolar, 1.2, \
                powerwallFieldGrid, 4.3, powerwallFieldPowerwall, 0, \
                powerwallFieldBatteryPercent, 15, powerwallFieldBackupPercent, 20 \
            ), \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 45), \
                powerwallFieldHome, 6.1, powerwallFieldSolar, 0.8, \
                powerwallFieldGrid, 5.3, powerwallFieldPowerwall, 0, \
                powerwallFieldBatteryPercent, 15, powerwallFieldBackupPercent, 20 \
            ) \
        ) \
    )
endfunction
unittestRunTest('testPowerwallSimulate_solarDeficit_belowBackup')


#
# powerwallSimulate tests with vehicle scenario
#


function testPowerwallSimulate_vehicleScenario()
    data = powerwallSimulate( \
        objectNew( \
            'name', 'Powerwall Scenario', \
            'batteryCapacity', 40, \
            'backupPercent', 20, \
            'chargeRatio', 0.95, \
            'dischargeRatio', 0.95, \
            'data', arrayNew( \
                objectNew(powerwallFieldDate, datetimeNew(2023, 4, 18, 0),  powerwallFieldHome, 0.4, powerwallFieldSolar, 0), \
                objectNew(powerwallFieldDate, datetimeNew(2023, 4, 18, 4),  powerwallFieldHome, 0.6, powerwallFieldSolar, 0), \
                objectNew(powerwallFieldDate, datetimeNew(2023, 4, 18, 8),  powerwallFieldHome, 1.8, powerwallFieldSolar, 1.3), \
                objectNew(powerwallFieldDate, datetimeNew(2023, 4, 18, 12), powerwallFieldHome, 0.7, powerwallFieldSolar, 6.3), \
                objectNew(powerwallFieldDate, datetimeNew(2023, 4, 18, 16), powerwallFieldHome, 1.2, powerwallFieldSolar, 5.8), \
                objectNew(powerwallFieldDate, datetimeNew(2023, 4, 18, 20), powerwallFieldHome, 2.2, powerwallFieldSolar, 0.8), \
                objectNew(powerwallFieldDate, datetimeNew(2023, 4, 19, 0),  powerwallFieldHome, 0.4, powerwallFieldSolar, 0), \
                objectNew(powerwallFieldDate, datetimeNew(2023, 4, 19, 4),  powerwallFieldHome, 0.6, powerwallFieldSolar, 0), \
                objectNew(powerwallFieldDate, datetimeNew(2023, 4, 19, 8),  powerwallFieldHome, 1.8, powerwallFieldSolar, 1.3), \
                objectNew(powerwallFieldDate, datetimeNew(2023, 4, 19, 12), powerwallFieldHome, 0.7, powerwallFieldSolar, 6.3), \
                objectNew(powerwallFieldDate, datetimeNew(2023, 4, 19, 16), powerwallFieldHome, 1.2, powerwallFieldSolar, 5.8), \
                objectNew(powerwallFieldDate, datetimeNew(2023, 4, 19, 20), powerwallFieldHome, 2.2, powerwallFieldSolar, 0.8) \
            ) \
        ), \
        75, \
        powerwallValidateVehicleScenario(objectNew( \
            'name', 'Vehicle Scenario', \
            'vehicles', arrayNew( \
                objectNew( \
                    'id', 'ID-1', \
                    'battery', 90, \
                    'batteryCapacity', 80, \
                    'chargingLimit', 90, \
                    'chargingRate', 5, \
                    'minChargingRate', 5, \
                    'maxChargingRate', 12, \
                    'chargingVoltage', 120 \
                ) \
            ), \
            'days', arrayNew( \
                objectNew( \
                    'departures', arrayNew( \
                        objectNew( \
                            'id', 'ID-1', \
                            'departure', 8, \
                            'arrival', 12, \
                            'batteryChange', -10 \
                        ) \
                    ) \
                ) \
            ) \
        )) \
    )
    unittestDeepEquals( \
        data, \
        arrayNew( \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 18, 0, 0), \
                powerwallFieldHome, 0.4, powerwallFieldSolar, 0, \
                powerwallFieldGrid, 0, powerwallFieldPowerwall, 0.4, \
                powerwallFieldBatteryPercent, 70.789, powerwallFieldBackupPercent, 20, \
                'Vehicle ID-1 (kWh)', 0, 'Vehicle ID-1 Connected', 1, 'Vehicle ID-1 Battery (%)', 90, \
                'Vehicle ID-1 Charging Limit (%)', 90, 'Vehicle ID-1 Charging Rate (amps)', 5 \
            ), \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 0), \
                powerwallFieldHome, 0.6, powerwallFieldSolar, 0, \
                powerwallFieldGrid, 0, powerwallFieldPowerwall, 0.6, \
                powerwallFieldBatteryPercent, 64.474, powerwallFieldBackupPercent, 20, \
                'Vehicle ID-1 (kWh)', 0, 'Vehicle ID-1 Connected', 1, 'Vehicle ID-1 Battery (%)', 90, \
                'Vehicle ID-1 Charging Limit (%)', 90, 'Vehicle ID-1 Charging Rate (amps)', 5 \
            ), \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 18, 8, 0), \
                powerwallFieldHome, 1.8, powerwallFieldSolar, 1.3, \
                powerwallFieldGrid, 0, powerwallFieldPowerwall, 0.5, \
                powerwallFieldBatteryPercent, 59.211, powerwallFieldBackupPercent, 20, \
                'Vehicle ID-1 (kWh)', 0, 'Vehicle ID-1 Connected', 0, 'Vehicle ID-1 Battery (%)', 90, \
                'Vehicle ID-1 Charging Limit (%)', 90, 'Vehicle ID-1 Charging Rate (amps)', 5 \
            ), \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 18, 12, 0), \
                powerwallFieldHome, 0.7, powerwallFieldSolar, 6.3, \
                powerwallFieldGrid, -1.306, powerwallFieldPowerwall, -4.294, \
                powerwallFieldBatteryPercent, 100, powerwallFieldBackupPercent, 20, \
                'Vehicle ID-1 (kWh)', 0, 'Vehicle ID-1 Connected', 0, 'Vehicle ID-1 Battery (%)', 90, \
                'Vehicle ID-1 Charging Limit (%)', 90, 'Vehicle ID-1 Charging Rate (amps)', 5 \
            ), \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 18, 16, 0), \
                powerwallFieldHome, 1.8, powerwallFieldSolar, 5.8, \
                powerwallFieldGrid, -4, powerwallFieldPowerwall, 0, \
                powerwallFieldBatteryPercent, 100, powerwallFieldBackupPercent, 20, \
                'Vehicle ID-1 (kWh)', -0.6, 'Vehicle ID-1 Connected', 1, 'Vehicle ID-1 Battery (%)', 83, \
                'Vehicle ID-1 Charging Limit (%)', 90, 'Vehicle ID-1 Charging Rate (amps)', 5 \
            ), \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 18, 20, 0), \
                powerwallFieldHome, 2.8, powerwallFieldSolar, 0.8, \
                powerwallFieldGrid, 0, powerwallFieldPowerwall, 2, \
                powerwallFieldBatteryPercent, 78.947, powerwallFieldBackupPercent, 20, \
                'Vehicle ID-1 (kWh)', -0.6, 'Vehicle ID-1 Connected', 1, 'Vehicle ID-1 Battery (%)', 86, \
                'Vehicle ID-1 Charging Limit (%)', 90, 'Vehicle ID-1 Charging Rate (amps)', 5 \
            ), \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 19, 0, 0), \
                powerwallFieldHome, 1, powerwallFieldSolar, 0, \
                powerwallFieldGrid, 0, powerwallFieldPowerwall, 1, \
                powerwallFieldBatteryPercent, 68.421, powerwallFieldBackupPercent, 20, \
                'Vehicle ID-1 (kWh)', -0.6, 'Vehicle ID-1 Connected', 1, 'Vehicle ID-1 Battery (%)', 89, \
                'Vehicle ID-1 Charging Limit (%)', 90, 'Vehicle ID-1 Charging Rate (amps)', 5 \
            ), \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 19, 4, 0), \
                powerwallFieldHome, 0.8, powerwallFieldSolar, 0, \
                powerwallFieldGrid, 0, powerwallFieldPowerwall, 0.8, \
                powerwallFieldBatteryPercent, 60, powerwallFieldBackupPercent, 20, \
                'Vehicle ID-1 (kWh)', -0.2, 'Vehicle ID-1 Connected', 1, 'Vehicle ID-1 Battery (%)', 90, \
                'Vehicle ID-1 Charging Limit (%)', 90, 'Vehicle ID-1 Charging Rate (amps)', 5 \
            ), \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 19, 8, 0), \
                powerwallFieldHome, 1.8, powerwallFieldSolar, 1.3, \
                powerwallFieldGrid, 0, powerwallFieldPowerwall, 0.5, \
                powerwallFieldBatteryPercent, 54.737, powerwallFieldBackupPercent, 20, \
                'Vehicle ID-1 (kWh)', 0, 'Vehicle ID-1 Connected', 0, 'Vehicle ID-1 Battery (%)', 90, \
                'Vehicle ID-1 Charging Limit (%)', 90, 'Vehicle ID-1 Charging Rate (amps)', 5 \
            ), \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 19, 12, 0), \
                powerwallFieldHome, 0.7, powerwallFieldSolar, 6.3, \
                powerwallFieldGrid, -0.835, powerwallFieldPowerwall, -4.765, \
                powerwallFieldBatteryPercent, 100, powerwallFieldBackupPercent, 20, \
                'Vehicle ID-1 (kWh)', 0, 'Vehicle ID-1 Connected', 0, 'Vehicle ID-1 Battery (%)', 90, \
                'Vehicle ID-1 Charging Limit (%)', 90, 'Vehicle ID-1 Charging Rate (amps)', 5 \
            ), \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 19, 16, 0), \
                powerwallFieldHome, 1.8, powerwallFieldSolar, 5.8, \
                powerwallFieldGrid, -4, powerwallFieldPowerwall, 0, \
                powerwallFieldBatteryPercent, 100, powerwallFieldBackupPercent, 20, \
                'Vehicle ID-1 (kWh)', -0.6, 'Vehicle ID-1 Connected', 1, 'Vehicle ID-1 Battery (%)', 83, \
                'Vehicle ID-1 Charging Limit (%)', 90, 'Vehicle ID-1 Charging Rate (amps)', 5 \
            ), \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 19, 20, 0), \
                powerwallFieldHome, 2.8, powerwallFieldSolar, 0.8, \
                powerwallFieldGrid, 0, powerwallFieldPowerwall, 2, \
                powerwallFieldBatteryPercent, 78.947, powerwallFieldBackupPercent, 20, \
                'Vehicle ID-1 (kWh)', -0.6, 'Vehicle ID-1 Connected', 1, 'Vehicle ID-1 Battery (%)', 86, \
                'Vehicle ID-1 Charging Limit (%)', 90, 'Vehicle ID-1 Charging Rate (amps)', 5 \
            ) \
        ) \
    )
endfunction
unittestRunTest('testPowerwallSimulate_vehicleScenario')


function testPowerwallSimulate_vehicleScenario_tespo()
    data = powerwallSimulate( \
        objectNew( \
            'name', 'Powerwall Scenario', \
            'batteryCapacity', 40, \
            'backupPercent', 20, \
            'chargeRatio', 0.95, \
            'dischargeRatio', 0.95, \
            'data', arrayNew( \
                objectNew(powerwallFieldDate, datetimeNew(2023, 4, 18, 0),  powerwallFieldHome, 0.4, powerwallFieldSolar, 0), \
                objectNew(powerwallFieldDate, datetimeNew(2023, 4, 18, 4),  powerwallFieldHome, 0.6, powerwallFieldSolar, 0), \
                objectNew(powerwallFieldDate, datetimeNew(2023, 4, 18, 8),  powerwallFieldHome, 1.8, powerwallFieldSolar, 1.3), \
                objectNew(powerwallFieldDate, datetimeNew(2023, 4, 18, 12), powerwallFieldHome, 0.7, powerwallFieldSolar, 6.3), \
                objectNew(powerwallFieldDate, datetimeNew(2023, 4, 18, 16), powerwallFieldHome, 1.2, powerwallFieldSolar, 5.8), \
                objectNew(powerwallFieldDate, datetimeNew(2023, 4, 18, 20), powerwallFieldHome, 2.2, powerwallFieldSolar, 0.8), \
                objectNew(powerwallFieldDate, datetimeNew(2023, 4, 19, 0),  powerwallFieldHome, 0.4, powerwallFieldSolar, 0), \
                objectNew(powerwallFieldDate, datetimeNew(2023, 4, 19, 4),  powerwallFieldHome, 0.6, powerwallFieldSolar, 0), \
                objectNew(powerwallFieldDate, datetimeNew(2023, 4, 19, 8),  powerwallFieldHome, 1.8, powerwallFieldSolar, 1.3), \
                objectNew(powerwallFieldDate, datetimeNew(2023, 4, 19, 12), powerwallFieldHome, 0.7, powerwallFieldSolar, 6.3), \
                objectNew(powerwallFieldDate, datetimeNew(2023, 4, 19, 16), powerwallFieldHome, 1.2, powerwallFieldSolar, 5.8), \
                objectNew(powerwallFieldDate, datetimeNew(2023, 4, 19, 20), powerwallFieldHome, 2.2, powerwallFieldSolar, 0.8) \
            ) \
        ), \
        75, \
        powerwallValidateVehicleScenario(objectNew( \
            'name', 'Vehicle Scenario', \
            'vehicles', arrayNew( \
                objectNew( \
                    'id', 'ID-1', \
                    'battery', 90, \
                    'batteryCapacity', 80, \
                    'chargingLimit', 90, \
                    'chargingRate', 5, \
                    'minChargingRate', 5, \
                    'maxChargingRate', 12, \
                    'chargingVoltage', 120 \
                ) \
            ), \
            'days', arrayNew( \
                objectNew( \
                    'departures', arrayNew( \
                        objectNew( \
                            'id', 'ID-1', \
                            'departure', 8, \
                            'arrival', 12, \
                            'batteryChange', -10 \
                        ) \
                    ) \
                ) \
            ) \
        )), \
        1 \
    )
    unittestDeepEquals( \
        data, \
        arrayNew( \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 18, 0, 0), \
                powerwallFieldHome, 0.4, powerwallFieldSolar, 0, \
                powerwallFieldGrid, 0, powerwallFieldPowerwall, 0.4, \
                powerwallFieldBatteryPercent, 70.789, powerwallFieldBackupPercent, 20, \
                'Vehicle ID-1 (kWh)', 0, 'Vehicle ID-1 Connected', 1, 'Vehicle ID-1 Battery (%)', 90, \
                'Vehicle ID-1 Charging Limit (%)', 50, 'Vehicle ID-1 Charging Rate (amps)', 5 \
            ), \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 18, 4, 0), \
                powerwallFieldHome, 0.6, powerwallFieldSolar, 0, \
                powerwallFieldGrid, 0, powerwallFieldPowerwall, 0.6, \
                powerwallFieldBatteryPercent, 64.474, powerwallFieldBackupPercent, 20, \
                'Vehicle ID-1 (kWh)', 0, 'Vehicle ID-1 Connected', 1, 'Vehicle ID-1 Battery (%)', 90, \
                'Vehicle ID-1 Charging Limit (%)', 50, 'Vehicle ID-1 Charging Rate (amps)', 5 \
            ), \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 18, 8, 0), \
                powerwallFieldHome, 1.8, powerwallFieldSolar, 1.3, \
                powerwallFieldGrid, 0, powerwallFieldPowerwall, 0.5, \
                powerwallFieldBatteryPercent, 59.211, powerwallFieldBackupPercent, 20, \
                'Vehicle ID-1 (kWh)', 0, 'Vehicle ID-1 Connected', 0, 'Vehicle ID-1 Battery (%)', 90, \
                'Vehicle ID-1 Charging Limit (%)', 50, 'Vehicle ID-1 Charging Rate (amps)', 5 \
            ), \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 18, 12, 0), \
                powerwallFieldHome, 0.7, powerwallFieldSolar, 6.3, \
                powerwallFieldGrid, -1.306, powerwallFieldPowerwall, -4.294, \
                powerwallFieldBatteryPercent, 100, powerwallFieldBackupPercent, 20, \
                'Vehicle ID-1 (kWh)', 0, 'Vehicle ID-1 Connected', 0, 'Vehicle ID-1 Battery (%)', 90, \
                'Vehicle ID-1 Charging Limit (%)', 50, 'Vehicle ID-1 Charging Rate (amps)', 5 \
            ), \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 18, 16, 0), \
                powerwallFieldHome, 2.64, powerwallFieldSolar, 5.8, \
                powerwallFieldGrid, -3.16, powerwallFieldPowerwall, 0, \
                powerwallFieldBatteryPercent, 100, powerwallFieldBackupPercent, 20, \
                'Vehicle ID-1 (kWh)', -1.44, 'Vehicle ID-1 Connected', 1, 'Vehicle ID-1 Battery (%)', 87.2, \
                'Vehicle ID-1 Charging Limit (%)', 90, 'Vehicle ID-1 Charging Rate (amps)', 12 \
            ), \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 18, 20, 0), \
                powerwallFieldHome, 2.76, powerwallFieldSolar, 0.8, \
                powerwallFieldGrid, 0, powerwallFieldPowerwall, 1.96, \
                powerwallFieldBatteryPercent, 79.368, powerwallFieldBackupPercent, 20, \
                'Vehicle ID-1 (kWh)', -0.56, 'Vehicle ID-1 Connected', 1, 'Vehicle ID-1 Battery (%)', 90, \
                'Vehicle ID-1 Charging Limit (%)', 90, 'Vehicle ID-1 Charging Rate (amps)', 12 \
            ), \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 19, 0, 0), \
                powerwallFieldHome, 0.4, powerwallFieldSolar, 0, \
                powerwallFieldGrid, 0, powerwallFieldPowerwall, 0.4, \
                powerwallFieldBatteryPercent, 75.158, powerwallFieldBackupPercent, 20, \
                'Vehicle ID-1 (kWh)', 0, 'Vehicle ID-1 Connected', 1, 'Vehicle ID-1 Battery (%)', 90, \
                'Vehicle ID-1 Charging Limit (%)', 50, 'Vehicle ID-1 Charging Rate (amps)', 5 \
            ), \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 19, 4, 0), \
                powerwallFieldHome, 0.6, powerwallFieldSolar, 0, \
                powerwallFieldGrid, 0, powerwallFieldPowerwall, 0.6, \
                powerwallFieldBatteryPercent, 68.842, powerwallFieldBackupPercent, 20, \
                'Vehicle ID-1 (kWh)', 0, 'Vehicle ID-1 Connected', 1, 'Vehicle ID-1 Battery (%)', 90, \
                'Vehicle ID-1 Charging Limit (%)', 50, 'Vehicle ID-1 Charging Rate (amps)', 5 \
            ), \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 19, 8, 0), \
                powerwallFieldHome, 1.8, powerwallFieldSolar, 1.3, \
                powerwallFieldGrid, 0, powerwallFieldPowerwall, 0.5, \
                powerwallFieldBatteryPercent, 63.579, powerwallFieldBackupPercent, 20, \
                'Vehicle ID-1 (kWh)', 0, 'Vehicle ID-1 Connected', 0, 'Vehicle ID-1 Battery (%)', 90, \
                'Vehicle ID-1 Charging Limit (%)', 50, 'Vehicle ID-1 Charging Rate (amps)', 5 \
            ), \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 19, 12, 0), \
                powerwallFieldHome, 0.7, powerwallFieldSolar, 6.3, \
                powerwallFieldGrid, -1.766, powerwallFieldPowerwall, -3.834, \
                powerwallFieldBatteryPercent, 100, powerwallFieldBackupPercent, 20, \
                'Vehicle ID-1 (kWh)', 0, 'Vehicle ID-1 Connected', 0, 'Vehicle ID-1 Battery (%)', 90, \
                'Vehicle ID-1 Charging Limit (%)', 50, 'Vehicle ID-1 Charging Rate (amps)', 5 \
            ), \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 19, 16, 0), \
                powerwallFieldHome, 2.64, powerwallFieldSolar, 5.8, \
                powerwallFieldGrid, -3.16, powerwallFieldPowerwall, 0, \
                powerwallFieldBatteryPercent, 100, powerwallFieldBackupPercent, 20, \
                'Vehicle ID-1 (kWh)', -1.44, 'Vehicle ID-1 Connected', 1, 'Vehicle ID-1 Battery (%)', 87.2, \
                'Vehicle ID-1 Charging Limit (%)', 90, 'Vehicle ID-1 Charging Rate (amps)', 12 \
            ), \
            objectNew( \
                powerwallFieldDate, datetimeNew(2023, 4, 19, 20, 0), \
                powerwallFieldHome, 2.76, powerwallFieldSolar, 0.8, \
                powerwallFieldGrid, 0, powerwallFieldPowerwall, 1.96, \
                powerwallFieldBatteryPercent, 79.368, powerwallFieldBackupPercent, 20, \
                'Vehicle ID-1 (kWh)', -0.56, 'Vehicle ID-1 Connected', 1, 'Vehicle ID-1 Battery (%)', 90, \
                'Vehicle ID-1 Charging Limit (%)', 90, 'Vehicle ID-1 Charging Rate (amps)', 12 \
            ) \
        ) \
    )
endfunction
unittestRunTest('testPowerwallSimulate_vehicleScenario_tespo')


#
# powerwallLoadScenario tests
#


# Mock fetch for powerwallLoadScenario tests
function testPowerwallLoadScenario_fetch(url, options, text)
    unittestEquals(options, null)
    if url == 'scenario.json':
        unittestEquals(text, null)
        return objectNew( \
            'name', 'Powerwall Scenario', \
            'batteryCapacity', 40, \
            'backupPercent', 20, \
            'chargeRatio', 0.95, \
            'dischargeRatio', 0.95, \
            'dataURLs', arrayNew('data1.json', 'data2.json') \
        )
    elif url == 'scenario2.json':
        unittestEquals(text, null)
        return objectNew( \
            'name', 'Powerwall Scenario 2', \
            'batteryCapacity', 40, \
            'backupPercent', 20, \
            'chargeRatio', 0.95, \
            'dischargeRatio', 0.95, \
            'dataURLs', arrayNew('data1.json', 'dataUnknown.json', 'data2.json') \
        )
    elif url == 'data/scenario3.json':
        unittestEquals(text, null)
        return objectNew( \
            'name', 'Powerwall Scenario 3', \
            'batteryCapacity', 40, \
            'backupPercent', 20, \
            'chargeRatio', 0.95, \
            'dischargeRatio', 0.95, \
            'dataURLs', arrayNew('data2.json') \
        )
    elif url == 'data/scenario4.json':
        unittestEquals(text, null)
        return objectNew( \
            'name', 'Powerwall Scenario 4', \
            'batteryCapacity', 40, \
            'backupPercent', 20, \
            'chargeRatio', 0.95, \
            'dischargeRatio', 0.95, \
            'dataURLs', arrayNew('/data2.json') \
        )
    elif url == 'scenario5.json':
        unittestEquals(text, null)
        return objectNew( \
            'name', 'Powerwall Scenario 5', \
            'batteryCapacity', 40, \
            'backupPercent', 20, \
            'chargeRatio', 0.95, \
            'dischargeRatio', 0.95, \
            'dataURLs', arrayNew('data3.json') \
        )
    elif stringEndsWith(url, 'data1.json'):
        return 'Date time,Home (kW),Solar (kW),Powerwall (kW),Grid (kW),Energy Remaining (%)' + stringFromCharCode(10) + \
            '2023-03-25T12:10:00-07:00,1.0,4.2,-3.2,0,' + stringFromCharCode(10) + \
            '2023-03-25T12:15:00-07:00,1.0,5.6,-4.6,0,58'
    elif stringEndsWith(url, 'data2.json'):
        return 'Date time,Home (kW),Solar (kW),Powerwall (kW),Grid (kW),Energy Remaining (%)' + stringFromCharCode(10) + \
            '2023-03-25T12:00:00-07:00,1.0,4.1,-3.1,0,55' + stringFromCharCode(10) + \
            '2023-03-25T12:05:00-07:00,1.0,3.7,-2.7,0,'
    elif stringEndsWith(url, 'data3.json'):
        return 'Date time,Home (kW),Solar (kW),Powerwall (kW),Grid (kW),Energy Remaining (%)' + stringFromCharCode(10) + \
            '2023-03-25T12:00:00-07:00,1.0,4.1,-3.1,0,55' + stringFromCharCode(10) + \
            '2023-03-25T12:05:00-07:00,1.0,3.7,-2.7,0,57' + stringFromCharCode(10) + \
            '2023-03-25T12:10:00-07:00,1.0,3.9,-2.9,0,' + stringFromCharCode(10) + \
            '2023-03-25T12:15:00-07:00,1.0,5.6,-4.6,0,0'
    elif arrayLength(url) != null:
        responses = arrayNew()
        for url_ in url:
            response = testPowerwallLoadScenario_fetch(url_, options, text)
            arrayPush(responses, response)
        endfor
        return responses
    endif
    return null
endfunction
testPowerwallFetchOrig = runtimeGetGlobal('httpFetch')
httpFetch = testPowerwallLoadScenario_fetch


async function testPowerwallLoadScenario()
    unittestDeepEquals( \
        powerwallLoadScenario('scenario.json'), \
        objectNew( \
            'name', 'Powerwall Scenario', \
            'batteryCapacity', 40, \
            'backupPercent', 20, \
            'chargeRatio', 0.95, \
            'dischargeRatio', 0.95, \
            'dataURLs', arrayNew('data1.json', 'data2.json'), \
            'data', arrayNew( \
                objectNew( \
                    powerwallFieldDate, '2023-03-25T19:00:00.000Z', \
                    powerwallFieldHome, 1, \
                    powerwallFieldSolar, 4.1, \
                    powerwallFieldPowerwall, -3.1, \
                    powerwallFieldGrid, 0, \
                    powerwallFieldBatteryPercent, 55 \
                ), \
                objectNew( \
                    powerwallFieldDate, '2023-03-25T19:05:00.000Z', \
                    powerwallFieldHome, 1, \
                    powerwallFieldSolar, 3.7, \
                    powerwallFieldPowerwall, -2.7, \
                    powerwallFieldGrid, 0, \
                    powerwallFieldBatteryPercent, 56 \
                ), \
                objectNew( \
                    powerwallFieldDate, '2023-03-25T19:10:00.000Z', \
                    powerwallFieldHome, 1, \
                    powerwallFieldSolar, 4.2, \
                    powerwallFieldPowerwall, -3.2, \
                    powerwallFieldGrid, 0, \
                    powerwallFieldBatteryPercent, 57 \
                ), \
                objectNew( \
                    powerwallFieldDate, '2023-03-25T19:15:00.000Z', \
                    powerwallFieldHome, 1, \
                    powerwallFieldSolar, 5.6, \
                    powerwallFieldPowerwall, -4.6, \
                    powerwallFieldGrid, 0, \
                    powerwallFieldBatteryPercent, 58 \
                ) \
            ) \
        ) \
    )
endfunction
unittestRunTestAsync('testPowerwallLoadScenario')


async function testPowerwallLoadScenario_relative()
    unittestDeepEquals( \
        powerwallLoadScenario('data/scenario3.json'), \
        objectNew( \
            'name', 'Powerwall Scenario 3', \
            'batteryCapacity', 40, \
            'backupPercent', 20, \
            'chargeRatio', 0.95, \
            'dischargeRatio', 0.95, \
            'dataURLs', arrayNew('data/data2.json'), \
            'data', arrayNew( \
                objectNew( \
                    powerwallFieldDate, '2023-03-25T19:00:00.000Z', \
                    powerwallFieldHome, 1, \
                    powerwallFieldSolar, 4.1, \
                    powerwallFieldPowerwall, -3.1, \
                    powerwallFieldGrid, 0, \
                    powerwallFieldBatteryPercent, 55 \
                ), \
                objectNew( \
                    powerwallFieldDate, '2023-03-25T19:05:00.000Z', \
                    powerwallFieldHome, 1, \
                    powerwallFieldSolar, 3.7, \
                    powerwallFieldPowerwall, -2.7, \
                    powerwallFieldGrid, 0, \
                    powerwallFieldBatteryPercent, 55 \
                ) \
            ) \
        ) \
    )
endfunction
unittestRunTestAsync('testPowerwallLoadScenario_relative')


async function testPowerwallLoadScenario_absolute()
    unittestDeepEquals( \
        powerwallLoadScenario('data/scenario4.json'), \
        objectNew( \
            'name', 'Powerwall Scenario 4', \
            'batteryCapacity', 40, \
            'backupPercent', 20, \
            'chargeRatio', 0.95, \
            'dischargeRatio', 0.95, \
            'dataURLs', arrayNew('/data2.json'), \
            'data', arrayNew( \
                objectNew( \
                    powerwallFieldDate, '2023-03-25T19:00:00.000Z', \
                    powerwallFieldHome, 1, \
                    powerwallFieldSolar, 4.1, \
                    powerwallFieldPowerwall, -3.1, \
                    powerwallFieldGrid, 0, \
                    powerwallFieldBatteryPercent, 55 \
                ), \
                objectNew( \
                    powerwallFieldDate, '2023-03-25T19:05:00.000Z', \
                    powerwallFieldHome, 1, \
                    powerwallFieldSolar, 3.7, \
                    powerwallFieldPowerwall, -2.7, \
                    powerwallFieldGrid, 0, \
                    powerwallFieldBatteryPercent, 55 \
                ) \
            ) \
        ) \
    )
endfunction
unittestRunTestAsync('testPowerwallLoadScenario_absolute')


async function testPowerwallLoadScenario_trailing_holes()
    unittestDeepEquals( \
        powerwallLoadScenario('scenario5.json'), \
        objectNew( \
            'name', 'Powerwall Scenario 5', \
            'batteryCapacity', 40, \
            'backupPercent', 20, \
            'chargeRatio', 0.95, \
            'dischargeRatio', 0.95, \
            'dataURLs', arrayNew('data3.json'), \
            'data', arrayNew( \
                objectNew( \
                    powerwallFieldDate, '2023-03-25T19:00:00.000Z', \
                    powerwallFieldHome, 1, \
                    powerwallFieldSolar, 4.1, \
                    powerwallFieldPowerwall, -3.1, \
                    powerwallFieldGrid, 0, \
                    powerwallFieldBatteryPercent, 55 \
                ), \
                objectNew( \
                    powerwallFieldDate, '2023-03-25T19:05:00.000Z', \
                    powerwallFieldHome, 1, \
                    powerwallFieldSolar, 3.7, \
                    powerwallFieldPowerwall, -2.7, \
                    powerwallFieldGrid, 0, \
                    powerwallFieldBatteryPercent, 57 \
                ), \
                objectNew( \
                    powerwallFieldDate, '2023-03-25T19:10:00.000Z', \
                    powerwallFieldHome, 1, \
                    powerwallFieldSolar, 3.9, \
                    powerwallFieldPowerwall, -2.9, \
                    powerwallFieldGrid, 0, \
                    powerwallFieldBatteryPercent, 59 \
                ), \
                objectNew( \
                    powerwallFieldDate, '2023-03-25T19:15:00.000Z', \
                    powerwallFieldHome, 1, \
                    powerwallFieldSolar, 5.6, \
                    powerwallFieldPowerwall, -4.6, \
                    powerwallFieldGrid, 0, \
                    powerwallFieldBatteryPercent, 61 \
                ) \
            ) \
        ) \
    )
endfunction
unittestRunTestAsync('testPowerwallLoadScenario_trailing_holes')


async function testPowerwallLoadScenario_notFound()
    unittestDeepEquals( \
        powerwallLoadScenario('scenarioUnknown.json'), \
        null \
    )
endfunction
unittestRunTestAsync('testPowerwallLoadScenario_notFound')


async function testPowerwallLoadScenario_notFoundData()
    unittestDeepEquals( \
        powerwallLoadScenario('scenario2.json'), \
        null \
    )
endfunction
unittestRunTestAsync('testPowerwallLoadScenario_notFoundData')


# Un-mock fetch
httpFetch = testPowerwallFetchOrig


#
# powerwallVehicleDeparted tests
#


function testPowerwallVehicleDeparted()
    unittestDeepEquals( \
        powerwallVehicleDeparted( \
            objectNew( \
                'departures', arrayNew( \
                    objectNew( \
                        'id', 'ID-1', \
                        'departure', 9, \
                        'arrival', 11, \
                        'batteryChange', -10 \
                    ), \
                    objectNew( \
                        'id', 'ID-1', \
                        'departure', 18, \
                        'arrival', 21, \
                        'batteryChange', -20 \
                    ) \
                ) \
            ), \
            'ID-1', \
            19 \
        ), \
        objectNew( \
            'id', 'ID-1', \
            'departure', 18, \
            'arrival', 21, \
            'batteryChange', -20 \
        ) \
    )
endfunction
unittestRunTest('testPowerwallVehicleDeparted')


function testPowerwallVehicleDeparted_connected()
    unittestDeepEquals( \
        powerwallVehicleDeparted( \
            objectNew( \
                'departures', arrayNew( \
                    objectNew( \
                        'id', 'ID-1', \
                        'departure', 9, \
                        'arrival', 11, \
                        'batteryChange', -10 \
                    ), \
                    objectNew( \
                        'id', 'ID-1', \
                        'departure', 18, \
                        'arrival', 21, \
                        'batteryChange', -20 \
                    ) \
                ) \
            ), \
            'ID-1', \
            12 \
        ), \
        null \
    )
endfunction
unittestRunTest('testPowerwallVehicleDeparted_connected')


function testPowerwallVehicleDeparted_connected_id()
    unittestDeepEquals( \
        powerwallVehicleDeparted( \
            objectNew( \
                'departures', arrayNew( \
                    objectNew( \
                        'id', 'ID-1', \
                        'departure', 9, \
                        'arrival', 11, \
                        'batteryChange', -10 \
                    ), \
                    objectNew( \
                        'id', 'ID-1', \
                        'departure', 18, \
                        'arrival', 21, \
                        'batteryChange', -20 \
                    ) \
                ) \
            ), \
            'ID-2', \
            19 \
        ), \
        null \
    )
endfunction
unittestRunTest('testPowerwallVehicleDeparted_connected_id')


#
# powerwallValidateVehicleScenario tests
#


function testPowerwallValidateVehicleScenario()
    vehicleScenario = objectNew( \
        'name', 'Vehicle Scenario', \
        'vehicles', arrayNew( \
            objectNew( \
                'id', 'ID-1', \
                'battery', 75, \
                'batteryCapacity', 80, \
                'chargingRate', 5, \
                'chargingLimit', 90, \
                'minChargingRate', 5, \
                'maxChargingRate', 32, \
                'chargingVoltage', 240 \
            ) \
        ), \
        'days', arrayNew( \
            objectNew( \
                'departures', arrayNew( \
                    objectNew( \
                        'id', 'ID-1', \
                        'departure', 9, \
                        'arrival', 11, \
                        'batteryChange', -10 \
                    ), \
                    objectNew( \
                        'id', 'ID-1', \
                        'departure', 18, \
                        'arrival', 21, \
                        'batteryChange', -20 \
                    ) \
                ) \
            ) \
        ) \
    )
    unittestDeepEquals(powerwallValidateVehicleScenario(vehicleScenario), vehicleScenario)
endfunction
unittestRunTest('testPowerwallValidateVehicleScenario')


function testPowerwallValidateVehicleScenario_fail()
    unittestDeepEquals(powerwallValidateVehicleScenario(objectNew()), vehicleScenario)
endfunction
unittestRunTest('testPowerwallValidateVehicleScenario_fail')
